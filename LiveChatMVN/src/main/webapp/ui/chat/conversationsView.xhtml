<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:f="http://java.sun.com/jsf/core">

<h:body>
	<p:tabView
		id="tvConversations"
		value="#{chat.conversations}"
		var="conversation">
		<p:ajax
			event="tabClose"
			listener="#{chat.endConversation}" />
		<p:ajax
			event="tabChange"
			listener="#{chat.switchActiveConversation}" />

		<p:tab
			title="#{chat.conversationTitle(conversation)}"
			closable="#{chat.isTabClosable(conversation)}">
			#{conversation}
			
			<p:outputPanel
				id="opConversation"
				layout="block"
				styleClass="conversationNo#{chat.conversationId(conversation)} ui-corner-all ui-widget-content message-panel">

				<ui:repeat
					var="message"
					value="#{chat.messagesOfConversation(conversation)}">
					<h:outputText
						styleClass="message-date"
						value="[#{chat.formatedDate(message.timeSent)}] " />
					<h:outputText
						styleClass="message-author"
						value="#{message.author.username}: " />
					<h:outputText
						styleClass="message-content"
						value="#{message.content}" />
					<br />
				</ui:repeat>
			</p:outputPanel>
		</p:tab>
	</p:tabView>

	<h:form id="fMsg">
		<p:inputText
			id="itMessage"
			value="#{chat.message}"
			styleClass="message-input">
		</p:inputText>
		<p:commandButton
			id="btnSendMessage"
			process="@this itMessage"
			update="@this itMessage"
			action="#{chat.sendMessage}"
			value="Send"
			icon="ui-icon-seek-next">
		</p:commandButton>
		<p:focus context="fMsg" />
	</h:form>

	<p:socket
		channel="/chat"
		onMessage="handleMessage"
		widgetVar="subscriber" />

	<script type="text/javascript">
		function handleMessage(data) {
			/* TODO: refactor this... */
			/* hacky way to send conversation id.
				we use it to choose to which output panel
				message we got should be appended */
			var splitIndex = data.search(' ');
			var conversationId = data.substring(0, splitIndex);
			var message = data.substring(splitIndex+1, data.length);
			
			var chatContent = $('.conversationNo'+conversationId);
			chatContent.append(message + '<br />');

			chatContent.scrollTop(99999);
			PrimeFaces.focus('fMsg:itMessage');
		}
	</script>

</h:body>
</html>