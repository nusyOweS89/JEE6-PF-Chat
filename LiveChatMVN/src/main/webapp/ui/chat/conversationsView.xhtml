<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:f="http://java.sun.com/jsf/core">

<h:body>
	<p:tabView id="tvConversations">
		<p:tab
			id="tShoutbox"
			title="Shoutbox">

			<p:outputPanel
				id="public"
				layout="block"
				styleClass="ui-corner-all ui-widget-content message-panel">
				
				<ui:repeat var="message" value="#{chat.messages}">
					<h:outputText styleClass="message-date" value="[#{chat.formatedDate(message.timeSent)}] " />
					<h:outputText styleClass="message-author" value="#{message.author.username}: " />
					<h:outputText styleClass="message-content" value="#{message.content}" />
					<br />
				</ui:repeat>
			</p:outputPanel>
		</p:tab>

		<p:tab
			id="tOne"
			closable="true"
			title="One">
			one
		</p:tab>

		<p:tab
			id="tTwo"
			closable="true"
			title="Two">
			two
		</p:tab>
	</p:tabView>

	<h:form>
		<p:inputText
			id="itMessage"
			value="#{chat.message}"
			styleClass="message-input">
		</p:inputText>
		<p:commandButton
			id="btnSendMessage"
			process="@this itMessage"
			update="@this itMessage"
			action="#{chat.sendMessage}"
			value="Send"
			icon="ui-icon-seek-next">
		</p:commandButton>
	</h:form>

	<p:socket
		channel="/chat"
		onMessage="handleMessage"
		widgetVar="subscriber" />

	<script type="text/javascript">
		function handleMessage(data) {
			var chatContent = $(PrimeFaces
					.escapeClientId('tvConversations:public'));
			chatContent.append(data + '<br />');

			chatContent.scrollTop(chatContent.height());
		}
	</script>

</h:body>
</html>